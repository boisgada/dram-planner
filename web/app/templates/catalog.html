{% extends "base.html" %}

{% block title %}Beverage Catalog - Dram Planner{% endblock %}

{% block content %}
<h1>Beverage Catalog</h1>

<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h2>Browse Beverages</h2>
        <div style="display: flex; gap: 0.5rem;">
            <button class="btn" onclick="showImportForm()">Import Beverages</button>
            <button class="btn btn-primary" onclick="showAddBeverageForm()">Add to My Collection</button>
        </div>
    </div>

    <!-- Import Form -->
    <div id="import-form" style="display: none; margin-bottom: 2rem; padding: 1rem; background: #f8f9fa; border-radius: 4px;">
        <h3>Import Beverages to Catalog</h3>
        <form id="import-catalog-form" enctype="multipart/form-data" onsubmit="importCatalog(event)">
            <div class="form-group">
                <label>File (CSV or JSON)</label>
                <input type="file" name="file" accept=".csv,.json" required>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" name="preview" id="catalog-import-preview">
                    Preview only (don't import)
                </label>
            </div>
            <p style="font-size: 0.9em; color: #666; margin-top: 0.5rem;">
                CSV columns: name, brand, category, abv, region, country, description, tasting_notes<br>
                JSON format: array of beverage objects
            </p>
            <button type="submit" class="btn btn-success">Import</button>
            <button type="button" class="btn" onclick="hideImportForm()">Cancel</button>
        </form>
        <div id="import-results" style="margin-top: 1rem;"></div>
    </div>

    <!-- Search and Filters -->
    <div class="search-filters" style="margin-bottom: 2rem; padding: 1rem; background: #f8f9fa; border-radius: 4px;">
        <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 1rem; align-items: end;">
            <div class="form-group">
                <label>Search</label>
                <input type="text" id="search-input" placeholder="Search by name, brand, or description..." onkeyup="searchCatalog()">
            </div>
            <div class="form-group">
                <label>Category</label>
                <select id="category-filter" onchange="searchCatalog()">
                    <option value="">All Categories</option>
                </select>
            </div>
            <div class="form-group">
                <label>Brand</label>
                <select id="brand-filter" onchange="searchCatalog()">
                    <option value="">All Brands</option>
                </select>
            </div>
            <div class="form-group">
                <button class="btn" onclick="clearFilters()">Clear Filters</button>
            </div>
        </div>
    </div>

    <!-- Results -->
    <div id="catalog-results">
        <p>Loading catalog...</p>
    </div>

    <!-- Pagination -->
    <div id="pagination" style="display: none; margin-top: 2rem; text-align: center;">
        <button class="btn" id="prev-page" onclick="previousPage()" disabled>Previous</button>
        <span id="page-info"></span>
        <button class="btn" id="next-page" onclick="nextPage()">Next</button>
    </div>
</div>

<!-- Add to Collection Modal -->
<div id="add-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 8px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
        <h3>Add to My Collection</h3>
        <div id="selected-beverage-info" style="margin-bottom: 1rem;"></div>

        <form id="add-to-collection-form" onsubmit="addToCollection(event)">
            <input type="hidden" id="selected-beverage-id" name="catalog_id">

            <div class="form-group">
                <label>Name *</label>
                <input type="text" name="name" required>
            </div>
            <div class="form-group">
                <label>Category *</label>
                <select name="category" required>
                    <option value="bourbon">Bourbon</option>
                    <option value="scotch">Scotch</option>
                    <option value="irish">Irish</option>
                    <option value="gin">Gin</option>
                    <option value="vodka">Vodka</option>
                    <option value="rum">Rum</option>
                    <option value="tequila">Tequila</option>
                    <option value="liqueur">Liqueur</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label>ABV (%)</label>
                <input type="number" name="abv" step="0.1" min="0" max="100">
            </div>
            <div class="form-group">
                <label>Price Paid</label>
                <input type="number" name="price_paid" step="0.01" min="0">
            </div>
            <div class="form-group">
                <label>Purchase Date</label>
                <input type="date" name="purchase_date">
            </div>
            <div class="form-group">
                <label>Notes</label>
                <textarea name="notes" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label>Photo</label>
                <input type="file" name="photo" id="collection-photo-input" accept="image/png,image/jpeg,image/jpg,image/gif">
                <div id="collection-photo-preview" style="margin-top: 0.5rem;"></div>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1rem;">
                <button type="button" class="btn" onclick="closeAddModal()">Cancel</button>
                <button type="submit" class="btn btn-success">Add to Collection</button>
            </div>
        </form>
    </div>
</div>

<script>
let currentPage = 0;
const pageSize = 20;
let currentQuery = '';
let currentCategory = '';
let currentBrand = '';

function loadCatalog() {
    searchCatalog();
}

function searchCatalog() {
    currentQuery = document.getElementById('search-input').value;
    currentCategory = document.getElementById('category-filter').value;
    currentBrand = document.getElementById('brand-filter').value;
    currentPage = 0;

    performSearch();
}

function performSearch() {
    const resultsDiv = document.getElementById('catalog-results');
    resultsDiv.innerHTML = '<p>Searching...</p>';

    let url = `/api/catalog/search?limit=${pageSize}&offset=${currentPage * pageSize}`;
    if (currentQuery) url += `&q=${encodeURIComponent(currentQuery)}`;
    if (currentCategory) url += `&category=${encodeURIComponent(currentCategory)}`;
    if (currentBrand) url += `&brand=${encodeURIComponent(currentBrand)}`;

    fetch(url)
        .then(response => response.json())
        .then(data => {
            displayResults(data);
        })
        .catch(error => {
            console.error('Error searching catalog:', error);
            resultsDiv.innerHTML = '<p>Error loading catalog. Please try again.</p>';
        });
}

function displayResults(data) {
    const resultsDiv = document.getElementById('catalog-results');

    if (data.beverages.length === 0) {
        resultsDiv.innerHTML = '<p>No beverages found matching your criteria.</p>';
        document.getElementById('pagination').style.display = 'none';
        return;
    }

    let html = '<div class="beverages-grid">';
    data.beverages.forEach(beverage => {
        html += `
            <div class="beverage-card" onclick="selectBeverage(${beverage.id})">
                <div class="beverage-header">
                    <h4>${beverage.name}</h4>
                    ${beverage.brand ? `<p class="brand">${beverage.brand}</p>` : ''}
                </div>
                <div class="beverage-details">
                    <span class="category">${beverage.category}</span>
                    ${beverage.abv ? `<span class="abv">${beverage.abv}% ABV</span>` : ''}
                </div>
                ${beverage.description ? `<p class="description">${beverage.description}</p>` : ''}
                <div class="beverage-actions">
                    <button class="btn btn-sm" onclick="event.stopPropagation(); viewBeverageDetails(${beverage.id})">Details</button>
                    <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); selectBeverage(${beverage.id})">Add to Collection</button>
                </div>
            </div>
        `;
    });
    html += '</div>';

    resultsDiv.innerHTML = html;

    // Update pagination
    updatePagination(data);
}

function updatePagination(data) {
    const totalPages = Math.ceil(data.total / pageSize);
    const paginationDiv = document.getElementById('pagination');
    const prevBtn = document.getElementById('prev-page');
    const nextBtn = document.getElementById('next-page');
    const pageInfo = document.getElementById('page-info');

    if (totalPages <= 1) {
        paginationDiv.style.display = 'none';
        return;
    }

    paginationDiv.style.display = 'block';
    pageInfo.textContent = `Page ${currentPage + 1} of ${totalPages}`;

    prevBtn.disabled = currentPage === 0;
    nextBtn.disabled = currentPage >= totalPages - 1;
}

function previousPage() {
    if (currentPage > 0) {
        currentPage--;
        performSearch();
    }
}

function nextPage() {
    currentPage++;
    performSearch();
}

function clearFilters() {
    document.getElementById('search-input').value = '';
    document.getElementById('category-filter').value = '';
    document.getElementById('brand-filter').value = '';
    searchCatalog();
}

function showImportForm() {
    document.getElementById('import-form').style.display = 'block';
    document.getElementById('catalog-import-preview').checked = true; // Default to preview
}

function hideImportForm() {
    document.getElementById('import-form').style.display = 'none';
    document.getElementById('import-catalog-form').reset();
    document.getElementById('import-results').innerHTML = '';
}

function importCatalog(event) {
    event.preventDefault();

    const formData = new FormData(event.target);
    const preview = formData.get('preview') === 'on';

    const resultsDiv = document.getElementById('import-results');
    resultsDiv.innerHTML = '<p>Importing...</p>';

    fetch('/api/catalog/import', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        let html = '<div style="padding: 1rem; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 4px; margin-top: 1rem;">';
        html += `<p><strong>${data.message}</strong></p>`;

        if (data.errors && data.errors.length > 0) {
            html += '<p>Errors:</p><ul>';
            data.errors.forEach(error => {
                html += `<li>${error}</li>`;
            });
            html += '</ul>';
        }

        html += '</div>';
        resultsDiv.innerHTML = html;

        if (data.imported > 0 && !preview) {
            // Reload the catalog to show new items
            loadFilters();
            loadCatalog();
        }
    })
    .catch(error => {
        console.error('Import error:', error);
        resultsDiv.innerHTML = '<div style="padding: 1rem; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; margin-top: 1rem;"><p><strong>Import failed. Please try again.</strong></p></div>';
    });
}

function loadFilters() {
    // Load categories
    fetch('/api/catalog/categories')
        .then(response => response.json())
        .then(data => {
            const categorySelect = document.getElementById('category-filter');
            data.categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category.charAt(0).toUpperCase() + category.slice(1);
                categorySelect.appendChild(option);
            });
        });

    // Load brands
    fetch('/api/catalog/brands')
        .then(response => response.json())
        .then(data => {
            const brandSelect = document.getElementById('brand-filter');
            data.brands.forEach(brand => {
                const option = document.createElement('option');
                option.value = brand;
                option.textContent = brand;
                brandSelect.appendChild(option);
            });
        });
}

function selectBeverage(beverageId) {
    fetch(`/api/catalog/${beverageId}`)
        .then(response => response.json())
        .then(beverage => {
            showAddBeverageForm(beverage);
        });
}

function showAddBeverageForm(beverage = null) {
    const modal = document.getElementById('add-modal');
    const form = document.getElementById('add-to-collection-form');
    const infoDiv = document.getElementById('selected-beverage-info');

    if (beverage) {
        // Pre-populate form with catalog data
        document.getElementById('selected-beverage-id').value = beverage.id;
        form.name.value = beverage.name;
        form.category.value = beverage.category;
        form.abv.value = beverage.abv || '';
        form.notes.value = beverage.description || '';

        infoDiv.innerHTML = `
            <div style="background: #e3f2fd; padding: 1rem; border-radius: 4px; margin-bottom: 1rem;">
                <h4>Adding from Catalog:</h4>
                <p><strong>${beverage.name}</strong></p>
                ${beverage.brand ? `<p>Brand: ${beverage.brand}</p>` : ''}
                <p>Category: ${beverage.category}</p>
                ${beverage.abv ? `<p>ABV: ${beverage.abv}%</p>` : ''}
                ${beverage.description ? `<p>${beverage.description}</p>` : ''}
            </div>
        `;
    } else {
        // Clear form for manual entry
        document.getElementById('selected-beverage-id').value = '';
        form.reset();
        infoDiv.innerHTML = '';
    }

    modal.style.display = 'block';
}

function closeAddModal() {
    document.getElementById('add-modal').style.display = 'none';
}

function addToCollection(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    const photoFile = document.getElementById('collection-photo-input').files[0];

    // Remove the catalog_id from form data as it's not needed for bottle creation
    formData.delete('catalog_id');

    // First create the bottle
    const data = Object.fromEntries(formData);
    delete data.photo; // Remove photo from JSON data

    fetch('/api/bottles', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(bottleData => {
        if (bottleData.error) {
            alert('Error adding bottle: ' + bottleData.error);
            return;
        }

        // If there's a photo, upload it separately
        if (photoFile) {
            const photoFormData = new FormData();
            photoFormData.append('photo', photoFile);

            return fetch(`/api/bottles/${bottleData.id}/photo`, {
                method: 'POST',
                body: photoFormData
            });
        }
    })
    .then(response => {
        if (response && !response.ok) {
            throw new Error('Photo upload failed');
        }
        closeAddModal();
        alert('Bottle added to your collection successfully!');
    })
    .catch(error => {
        console.error('Error adding bottle:', error);
        alert('Error adding bottle to collection');
    });
}

function viewBeverageDetails(beverageId) {
    fetch(`/api/catalog/${beverageId}`)
        .then(response => response.json())
        .then(beverage => {
            let details = `Name: ${beverage.name}\n`;
            if (beverage.brand) details += `Brand: ${beverage.brand}\n`;
            details += `Category: ${beverage.category}\n`;
            if (beverage.abv) details += `ABV: ${beverage.abv}%\n`;
            if (beverage.region) details += `Region: ${beverage.region}\n`;
            if (beverage.country) details += `Country: ${beverage.country}\n`;
            if (beverage.description) details += `\nDescription:\n${beverage.description}\n`;
            if (beverage.tasting_notes) details += `\nTasting Notes:\n${beverage.tasting_notes}\n`;

            alert(details);
        });
}

// Photo preview
document.addEventListener('DOMContentLoaded', function() {
    const photoInput = document.getElementById('collection-photo-input');
    if (photoInput) {
        photoInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('collection-photo-preview');
                    preview.innerHTML = `<img src="${e.target.result}" alt="Preview" style="max-width: 200px; max-height: 200px; border-radius: 4px; margin-top: 0.5rem;">`;
                };
                reader.readAsDataURL(file);
            }
        });
    }
});

// Load filters and initial catalog on page load
loadFilters();
loadCatalog();
</script>

<style>
.beverages-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
}

.beverage-card {
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 1rem;
    background: white;
    cursor: pointer;
    transition: box-shadow 0.2s, transform 0.1s;
}

.beverage-card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    transform: translateY(-2px);
}

.beverage-header h4 {
    margin: 0 0 0.5rem 0;
    color: #333;
}

.beverage-header .brand {
    margin: 0;
    color: #666;
    font-style: italic;
}

.beverage-details {
    display: flex;
    gap: 1rem;
    margin-bottom: 0.5rem;
}

.beverage-details .category {
    background: #007bff;
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    font-size: 0.8rem;
    text-transform: uppercase;
}

.beverage-details .abv {
    color: #666;
    font-size: 0.9rem;
}

.beverage-card .description {
    color: #666;
    font-size: 0.9rem;
    margin: 0.5rem 0;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.beverage-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 1rem;
}

.beverage-actions .btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.8rem;
}

.search-filters {
    border: 1px solid #ddd;
    border-radius: 4px;
}
</style>
{% endblock %}
