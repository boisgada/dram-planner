{% extends "base.html" %}

{% block title %}Groups - Dram Planner{% endblock %}

{% block content %}
<h1>Tasting Groups</h1>

<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h2>My Groups</h2>
        <button class="btn btn-primary" onclick="showCreateGroupForm()">Create Group</button>
    </div>

    <div id="groups-list">
        <p>Loading groups...</p>
    </div>
</div>

<!-- Create Group Modal -->
<div id="create-group-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 8px; max-width: 500px; width: 90%;">
        <h3>Create New Group</h3>
        <form id="create-group-form" onsubmit="createGroup(event)">
            <div class="form-group">
                <label>Group Name *</label>
                <input type="text" name="name" required placeholder="e.g., Whiskey Enthusiasts">
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea name="description" rows="3" placeholder="Describe your group's focus and goals..."></textarea>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" name="is_private">
                    Private Group (invite only)
                </label>
            </div>
            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1rem;">
                <button type="button" class="btn" onclick="closeCreateGroupModal()">Cancel</button>
                <button type="submit" class="btn btn-success">Create Group</button>
            </div>
        </form>
    </div>
</div>

<!-- Group Details Modal -->
<div id="group-details-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 8px; max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto;">
        <div id="group-details-header" style="margin-bottom: 1rem;">
            <button class="btn" onclick="closeGroupDetailsModal()" style="float: right;">√ó</button>
            <h3 id="group-details-name"></h3>
            <p id="group-details-description"></p>
        </div>

        <div id="group-details-content">
            <!-- Tabs for different sections -->
            <div class="group-tabs" style="margin-bottom: 1rem;">
                <button class="tab-btn active" onclick="showGroupTab('members')">Members</button>
                <button class="tab-btn" onclick="showGroupTab('schedules')">Schedules</button>
                <button class="tab-btn" onclick="showGroupTab('settings')">Settings</button>
            </div>

            <div id="members-tab" class="tab-content">
                <div id="group-members"></div>
            </div>

            <div id="schedules-tab" class="tab-content" style="display: none;">
                <div id="group-schedules"></div>
            </div>

            <div id="settings-tab" class="tab-content" style="display: none;">
                <div id="group-settings"></div>
            </div>
        </div>
    </div>
</div>

<script>
let currentGroupId = null;
let currentScheduleId = null;

function loadGroups() {
    fetch('/api/groups')
        .then(response => response.json())
        .then(data => {
            displayGroups(data.groups);
        })
        .catch(error => {
            console.error('Error loading groups:', error);
            document.getElementById('groups-list').innerHTML = '<p>Error loading groups.</p>';
        });
}

function displayGroups(groups) {
    const container = document.getElementById('groups-list');

    if (groups.length === 0) {
        container.innerHTML = '<p>You are not a member of any groups yet. <button class="btn btn-primary" onclick="showCreateGroupForm()">Create your first group!</button></p>';
        return;
    }

    let html = '<div class="groups-grid">';
    groups.forEach(group => {
        html += `
            <div class="group-card" onclick="viewGroup(${group.id})">
                <div class="group-header">
                    <h4>${group.name}</h4>
                    <span class="group-privacy">${group.is_private ? 'üîí Private' : 'üåê Public'}</span>
                </div>
                <p class="group-description">${group.description || 'No description'}</p>
                <div class="group-stats">
                    <span>${group.member_count} members</span>
                    <span>Created ${new Date(group.created_at).toLocaleDateString()}</span>
                </div>
            </div>
        `;
    });
    html += '</div>';

    container.innerHTML = html;
}

function showCreateGroupForm() {
    document.getElementById('create-group-modal').style.display = 'block';
}

function closeCreateGroupModal() {
    document.getElementById('create-group-modal').style.display = 'none';
    document.getElementById('create-group-form').reset();
}

function createGroup(event) {
    event.preventDefault();

    const formData = new FormData(event.target);
    const data = Object.fromEntries(formData);
    data.is_private = formData.has('is_private');

    fetch('/api/groups', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(group => {
        closeCreateGroupModal();
        loadGroups();
        alert(`Group "${group.name}" created successfully!`);
    })
    .catch(error => {
        console.error('Error creating group:', error);
        alert('Error creating group');
    });
}

function viewGroup(groupId) {
    currentGroupId = groupId;

    fetch(`/api/groups/${groupId}`)
        .then(response => response.json())
        .then(group => {
            document.getElementById('group-details-name').textContent = group.name;
            document.getElementById('group-details-description').textContent = group.description || 'No description';

            document.getElementById('group-details-modal').style.display = 'block';

            // Load members by default
            loadGroupMembers();
        })
        .catch(error => {
            console.error('Error loading group:', error);
            alert('Error loading group details');
        });
}

function closeGroupDetailsModal() {
    document.getElementById('group-details-modal').style.display = 'none';
    currentGroupId = null;
}

function showGroupTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.style.display = 'none';
    });

    // Remove active class from all buttons
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });

    // Show selected tab
    document.getElementById(tabName + '-tab').style.display = 'block';
    event.target.classList.add('active');

    // Load tab content
    switch(tabName) {
        case 'members':
            loadGroupMembers();
            break;
        case 'schedules':
            loadGroupSchedules();
            break;
        case 'settings':
            loadGroupSettings();
            break;
    }
}

function loadGroupMembers() {
    const container = document.getElementById('group-members');
    container.innerHTML = '<p>Loading members...</p>';

    fetch(`/api/groups/${currentGroupId}/members`)
        .then(response => response.json())
        .then(data => {
            let html = '<h4>Members</h4>';
            if (data.members.length === 0) {
                html += '<p>No members found.</p>';
            } else {
                html += '<div class="members-list">';
                data.members.forEach(member => {
                    html += `
                        <div class="member-item">
                            <span>${member.username}</span>
                            <span class="member-role">${member.role}</span>
                            <span class="member-joined">Joined ${new Date(member.joined_at).toLocaleDateString()}</span>
                        </div>
                    `;
                });
                html += '</div>';
            }
            container.innerHTML = html;
        })
        .catch(error => {
            console.error('Error loading members:', error);
            container.innerHTML = '<p>Error loading members.</p>';
        });
}

function loadGroupSchedules() {
    const container = document.getElementById('group-schedules');
    container.innerHTML = '<p>Loading schedules...</p><button class="btn btn-primary" onclick="createGroupSchedule()">Create Schedule</button>';

    fetch(`/api/groups/${currentGroupId}/schedules`)
        .then(response => response.json())
        .then(data => {
            let html = '<h4>Group Schedules</h4><button class="btn btn-primary" onclick="createGroupSchedule()">Create Schedule</button><br><br>';

            if (data.schedules.length === 0) {
                html += '<p>No schedules created yet.</p>';
            } else {
                html += '<div class="schedules-list">';
                data.schedules.forEach(schedule => {
                    html += `
                        <div class="schedule-item" onclick="viewGroupSchedule(${schedule.id})">
                            <h5>${schedule.name}</h5>
                            <p>${schedule.description || 'No description'}</p>
                            <div class="schedule-meta">
                                <span>Started: ${new Date(schedule.start_date).toLocaleDateString()}</span>
                                <span>${schedule.weeks} weeks</span>
                                <span>${schedule.item_count} tastings</span>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }
            container.innerHTML = html;
        })
        .catch(error => {
            console.error('Error loading schedules:', error);
            container.innerHTML = '<p>Error loading schedules.</p>';
        });
}

function loadGroupSettings() {
    const container = document.getElementById('group-settings');
    container.innerHTML = '<h4>Group Settings</h4><p>Settings functionality coming soon...</p>';
}

function createGroupSchedule() {
    // Show a more comprehensive schedule creation form
    showScheduleCreationForm();
}

function showScheduleCreationForm() {
    const modal = document.createElement('div');
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;';
    modal.innerHTML = `
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 8px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
            <h3>Create Group Schedule</h3>
            <form id="schedule-creation-form" onsubmit="submitGroupSchedule(event)">
                <div class="form-group">
                    <label>Schedule Name *</label>
                    <input type="text" name="name" required placeholder="e.g., Holiday Tasting 2025">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea name="description" rows="3" placeholder="Optional description..."></textarea>
                </div>
                <div class="form-group">
                    <label>Start Date *</label>
                    <input type="date" name="start_date" required value="${new Date().toISOString().split('T')[0]}">
                </div>
                <div class="form-group">
                    <label>Duration (weeks) *</label>
                    <input type="number" name="weeks" required min="1" max="104" value="52">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" name="use_catalog" id="use-catalog" checked>
                        Include bottles from master catalog
                    </label>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1rem;">
                    <button type="button" onclick="closeScheduleCreationModal()">Cancel</button>
                    <button type="submit" class="btn btn-success">Create Schedule</button>
                </div>
            </form>
        </div>
    `;
    document.body.appendChild(modal);
}

function closeScheduleCreationModal() {
    const modal = document.querySelector('div[style*="position: fixed"]');
    if (modal) modal.remove();
}

function submitGroupSchedule(event) {
    event.preventDefault();

    const formData = new FormData(event.target);
    const data = {
        name: formData.get('name'),
        description: formData.get('description'),
        start_date: formData.get('start_date'),
        weeks: parseInt(formData.get('weeks')),
        use_catalog: formData.has('use_catalog')
    };

    fetch(`/api/groups/${currentGroupId}/schedules`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(schedule => {
        closeScheduleCreationModal();
        loadGroupSchedules();
        alert(`Schedule "${schedule.name}" created successfully!`);
    })
    .catch(error => {
        console.error('Error creating schedule:', error);
        alert('Error creating schedule');
    });
}

function viewGroupSchedule(scheduleId) {
    currentScheduleId = scheduleId;

    // Show schedule details in a modal
    fetch(`/api/groups/${currentGroupId}/schedules/${scheduleId}`)
        .then(response => response.json())
        .then(schedule => {
            // Get schedule items
            return fetch(`/api/groups/${currentGroupId}/schedules/${scheduleId}/items`)
                .then(response => response.json())
                .then(itemsData => {
                    showScheduleDetailsModal(schedule, itemsData.items);
                });
        })
        .catch(error => {
            console.error('Error loading schedule:', error);
            alert('Error loading schedule details');
        });
}

function showScheduleDetailsModal(schedule, items) {
    const modal = document.createElement('div');
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;';
    modal.innerHTML = `
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 8px; max-width: 900px; width: 90%; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                <div>
                    <h3>${schedule.name}</h3>
                    ${schedule.description ? `<p>${schedule.description}</p>` : ''}
                    <p><strong>Duration:</strong> ${schedule.weeks} weeks starting ${new Date(schedule.start_date).toLocaleDateString()}</p>
                </div>
                <button onclick="closeScheduleDetailsModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">√ó</button>
            </div>

            <div class="schedule-items">
                ${generateScheduleItemsHTML(items)}
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function generateScheduleItemsHTML(items) {
    if (!items || items.length === 0) {
        return '<p>No schedule items found.</p>';
    }

    let html = '<table class="schedule-table"><thead><tr><th>Week</th><th>Date</th><th>Bottle</th><th>Category</th><th>Status</th><th>Action</th></tr></thead><tbody>';

    items.forEach(item => {
        const status = item.completed ? '‚úÖ Completed' : '‚è≥ Pending';
        const statusClass = item.completed ? 'completed' : 'pending';

        html += `
            <tr class="${statusClass}">
                <td>${item.week}</td>
                <td>${new Date(item.tasting_date).toLocaleDateString()}</td>
                <td>${item.bottle_name}</td>
                <td><span class="category-badge">${item.category}</span></td>
                <td>${status}</td>
                <td>
                    ${!item.completed ?
                        `<button onclick="markItemComplete(${item.id})" class="btn btn-sm btn-success">Mark Complete</button>` :
                        `Completed by ${item.completed_by}`
                    }
                </td>
            </tr>
        `;
    });

    html += '</tbody></table>';
    return html;
}

function closeScheduleDetailsModal() {
    const modal = document.querySelector('div[style*="position: fixed"]');
    if (modal) modal.remove();
}

function markItemComplete(itemId) {
    fetch(`/api/groups/${currentGroupId}/schedules/${currentScheduleId}/items/${itemId}/complete`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(result => {
        if (result.error) {
            alert('Error: ' + result.error);
        } else {
            // Refresh the schedule view - reload the modal content
            closeScheduleDetailsModal();
            viewGroupSchedule(currentScheduleId);
        }
    })
    .catch(error => {
        console.error('Error marking item complete:', error);
        alert('Error updating item');
    });
}

// Load groups on page load
loadGroups();
</script>

<style>
.groups-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
}

.group-card {
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 1rem;
    background: white;
    cursor: pointer;
    transition: box-shadow 0.2s;
}

.group-card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.group-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.5rem;
}

.group-header h4 {
    margin: 0;
    color: #333;
}

.group-privacy {
    font-size: 0.8rem;
    color: #666;
    background: #f8f9fa;
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
}

.group-description {
    color: #666;
    margin: 0.5rem 0;
    font-size: 0.9rem;
}

.group-stats {
    display: flex;
    justify-content: space-between;
    font-size: 0.8rem;
    color: #999;
}

.members-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.member-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem;
    background: #f8f9fa;
    border-radius: 4px;
}

.member-role {
    font-weight: bold;
    color: #007bff;
}

.member-joined {
    font-size: 0.8rem;
    color: #666;
}

.schedules-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.schedule-item {
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 1rem;
    background: white;
    cursor: pointer;
    transition: box-shadow 0.2s;
}

.schedule-item:hover {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.schedule-item h5 {
    margin: 0 0 0.5rem 0;
    color: #333;
}

.schedule-meta {
    display: flex;
    gap: 1rem;
    font-size: 0.8rem;
    color: #666;
}

.group-tabs {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.tab-btn {
    padding: 0.5rem 1rem;
    border: 1px solid #ddd;
    background: #f8f9fa;
    cursor: pointer;
    border-radius: 4px;
}

.tab-btn.active {
    background: #007bff;
    color: white;
    border-color: #007bff;
}

.tab-content {
    min-height: 200px;
}

.schedule-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
}

.schedule-table th, .schedule-table td {
    border: 1px solid #ddd;
    padding: 0.75rem;
    text-align: left;
}

.schedule-table th {
    background-color: #f8f9fa;
    font-weight: bold;
}

.schedule-table tr.completed {
    background-color: #d4edda;
}

.schedule-table tr.pending {
    background-color: #fff3cd;
}

.category-badge {
    background: #007bff;
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    font-size: 0.8rem;
    text-transform: uppercase;
}

.btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.8rem;
}
</style>
{% endblock %}
