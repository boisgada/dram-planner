{% extends "base.html" %}

{% block title %}Collection - Dram Planner{% endblock %}

{% block content %}
<h1>My Collection</h1>

    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 0.5rem;">
            <h2>Bottles</h2>
            <div style="display: flex; gap: 0.5rem;">
                <button class="btn" onclick="showImportForm()">Import</button>
                <button class="btn" onclick="exportBottles('json')">Export JSON</button>
                <button class="btn" onclick="exportBottles('csv')">Export CSV</button>
                <a href="{{ url_for('main.catalog') }}" class="btn">Browse Catalog</a>
                <button class="btn btn-primary" onclick="showAddBottleForm()">Add Bottle</button>
            </div>
        </div>

    <div id="import-form" style="display: none; margin-bottom: 2rem; padding: 1rem; background: #f8f9fa; border-radius: 4px;">
        <h3>Import Bottles</h3>
        <form id="import-form-element" enctype="multipart/form-data" onsubmit="importBottles(event)">
            <div class="form-group">
                <label>File (CSV or JSON)</label>
                <input type="file" name="file" accept=".csv,.json" required>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" name="preview" id="import-preview">
                    Preview only (don't import)
                </label>
            </div>
            <button type="submit" class="btn btn-success">Import</button>
            <button type="button" class="btn" onclick="hideImportForm()">Cancel</button>
        </form>
        <div id="import-results" style="margin-top: 1rem;"></div>
    </div>

    <div id="add-bottle-form" style="display: none; margin-bottom: 2rem; padding: 1rem; background: #f8f9fa; border-radius: 4px;">
        <h3>Add New Bottle</h3>
        <form id="bottle-form" onsubmit="addBottle(event)">
            <div class="form-group">
                <label>Name *</label>
                <input type="text" name="name" required>
            </div>
            <div class="form-group">
                <label>Category *</label>
                <select name="category" required>
                    <option value="bourbon">Bourbon</option>
                    <option value="scotch">Scotch</option>
                    <option value="irish">Irish</option>
                    <option value="gin">Gin</option>
                    <option value="vodka">Vodka</option>
                    <option value="rum">Rum</option>
                    <option value="tequila">Tequila</option>
                    <option value="liqueur">Liqueur</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label>Barcode/UPC</label>
                <div style="display: flex; gap: 0.5rem; align-items: flex-end;">
                    <input type="text" name="barcode" id="barcode-input" placeholder="Enter barcode or scan">
                    <button type="button" class="btn" onclick="lookupBarcode()" id="lookup-btn">Lookup</button>
                </div>
                <div id="barcode-result" style="margin-top: 0.5rem; font-size: 0.9em;"></div>
            </div>
            <div class="form-group">
                <label>ABV (%)</label>
                <input type="number" name="abv" step="0.1" min="0" max="100">
            </div>
            <div class="form-group">
                <label>Price Paid</label>
                <input type="number" name="price_paid" step="0.01" min="0">
            </div>
            <div class="form-group">
                <label>Purchase Date</label>
                <input type="date" name="purchase_date">
            </div>
            <div class="form-group">
                <label>Notes</label>
                <textarea name="notes" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label>Photo</label>
                <input type="file" name="photo" id="photo-input" accept="image/png,image/jpeg,image/jpg,image/gif">
                <div id="photo-preview" style="margin-top: 0.5rem;"></div>
            </div>
            <button type="submit" class="btn btn-success" id="submit-btn">Add Bottle</button>
            <button type="button" class="btn" onclick="hideAddBottleForm()">Cancel</button>
        </form>
    </div>

    <div style="margin-bottom: 1rem;">
        <input type="text" id="search" placeholder="Search bottles..." style="width: 300px; padding: 0.5rem;" onkeyup="loadBottles()">
        <select id="category-filter" onchange="loadBottles()" style="margin-left: 1rem; padding: 0.5rem;">
            <option value="">All Categories</option>
            <option value="bourbon">Bourbon</option>
            <option value="scotch">Scotch</option>
            <option value="irish">Irish</option>
            <option value="gin">Gin</option>
            <option value="vodka">Vodka</option>
            <option value="rum">Rum</option>
            <option value="tequila">Tequila</option>
            <option value="liqueur">Liqueur</option>
            <option value="other">Other</option>
        </select>
        <select id="tasted-filter" onchange="loadBottles()" style="margin-left: 1rem; padding: 0.5rem;">
            <option value="">All</option>
            <option value="true">Tasted</option>
            <option value="false">Untasted</option>
        </select>
    </div>

    <div id="bottles-table">
        <p>Loading bottles...</p>
    </div>
</div>

<script>
function showAddBottleForm() {
    document.getElementById('add-bottle-form').style.display = 'block';
}

function hideAddBottleForm() {
    document.getElementById('add-bottle-form').style.display = 'none';
    document.getElementById('bottle-form').reset();
    document.getElementById('bottle-form').querySelector('h3').textContent = 'Add New Bottle';
    document.getElementById('submit-btn').textContent = 'Add Bottle';
    document.getElementById('photo-preview').innerHTML = '';
    editingBottleId = null;
}

function loadBottles() {
    const search = document.getElementById('search').value;
    const category = document.getElementById('category-filter').value;
    const tasted = document.getElementById('tasted-filter').value;
    
    let url = '/api/bottles?';
    if (search) url += `search=${encodeURIComponent(search)}&`;
    if (category) url += `category=${encodeURIComponent(category)}&`;
    if (tasted) url += `tasted=${tasted}&`;
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            const table = document.getElementById('bottles-table');
            if (data.bottles.length === 0) {
                table.innerHTML = '<p>No bottles found.</p>';
                return;
            }
            
            let html = '<div class="table-wrapper"><table><thead><tr><th>Photo</th><th>Name</th><th>Category</th><th>ABV</th><th>Tasted</th><th>Rating</th><th>Actions</th></tr></thead><tbody>';
            data.bottles.forEach(bottle => {
                const photoCell = bottle.photo_url 
                    ? `<td><img src="${bottle.photo_url}" alt="${bottle.name}" style="max-width: 60px; max-height: 60px; object-fit: cover; border-radius: 4px;"></td>`
                    : '<td>-</td>';
                html += `<tr>
                    ${photoCell}
                    <td>${bottle.name}</td>
                    <td>${bottle.category}</td>
                    <td>${bottle.abv || 'N/A'}%</td>
                    <td>${bottle.tasted ? '✓' : '✗'}</td>
                    <td>${bottle.rating || 'N/A'}</td>
                    <td>
                        <button class="btn" onclick="viewBottle(${bottle.id})">Edit</button>
                        <button class="btn" onclick="uploadPhoto(${bottle.id})">${bottle.photo_url ? 'Change Photo' : 'Add Photo'}</button>
                        ${bottle.photo_url ? `<button class="btn" onclick="deletePhoto(${bottle.id})">Delete Photo</button>` : ''}
                        <button class="btn btn-danger" onclick="deleteBottle(${bottle.id})">Delete</button>
                        ${!bottle.tasted ? `<button class="btn btn-success" onclick="recordTasting(${bottle.id})">Record Tasting</button>` : ''}
                    </td>
                </tr>`;
            });
            html += '</tbody></table></div>';
            table.innerHTML = html;
        })
        .catch(error => {
            console.error('Error loading bottles:', error);
            document.getElementById('bottles-table').innerHTML = '<p>Error loading bottles.</p>';
        });
}

let editingBottleId = null;

function addBottle(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    const photoFile = document.getElementById('photo-input').files[0];
    
    // First create/update the bottle
    const data = Object.fromEntries(formData);
    delete data.photo; // Remove photo from JSON data
    
    const url = editingBottleId ? `/api/bottles/${editingBottleId}` : '/api/bottles';
    const method = editingBottleId ? 'PUT' : 'POST';
    
    fetch(url, {
        method: method,
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(bottleData => {
        // If there's a photo, upload it separately
        if (photoFile) {
            const photoFormData = new FormData();
            photoFormData.append('photo', photoFile);
            
            return fetch(`/api/bottles/${bottleData.id}/photo`, {
                method: 'POST',
                body: photoFormData
            }).then(() => bottleData);
        }
        return bottleData;
    })
    .then(data => {
        hideAddBottleForm();
        loadBottles();
        alert(editingBottleId ? 'Bottle updated successfully!' : 'Bottle added successfully!');
        editingBottleId = null;
    })
    .catch(error => {
        console.error('Error saving bottle:', error);
        alert('Error saving bottle');
    });
}

function recordTasting(bottleId) {
    const rating = prompt('Enter rating (0-10):');
    if (!rating) return;
    
    const notes = prompt('Enter tasting notes (optional):') || '';
    const dateInput = prompt('Enter tasting date (YYYY-MM-DD) or leave blank for today:');
    const date = dateInput || new Date().toISOString().split('T')[0];
    
    const ratingNum = parseFloat(rating);
    if (isNaN(ratingNum) || ratingNum < 0 || ratingNum > 10) {
        alert('Please enter a valid rating between 0 and 10');
        return;
    }
    
    fetch(`/api/bottles/${bottleId}/tasting`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            rating: ratingNum,
            tasting_notes: notes,
            tasting_date: date
        })
    })
    .then(response => {
        if (response.ok) {
            return response.json();
        } else {
            throw new Error('Failed to record tasting');
        }
    })
    .then(data => {
        loadBottles();
        alert('Tasting recorded successfully!');
    })
    .catch(error => {
        console.error('Error recording tasting:', error);
        alert('Error recording tasting. Please try again.');
    });
}

function viewBottle(bottleId) {
    fetch(`/api/bottles/${bottleId}`)
        .then(response => response.json())
        .then(bottle => {
            editingBottleId = bottle.id;
            document.getElementById('bottle-form').reset();
            document.getElementById('bottle-form').querySelector('h3').textContent = 'Edit Bottle';
            
            // Populate form
            document.querySelector('input[name="name"]').value = bottle.name || '';
            document.querySelector('select[name="category"]').value = bottle.category || 'other';
            document.querySelector('input[name="abv"]').value = bottle.abv || '';
            document.querySelector('input[name="price_paid"]').value = bottle.price_paid || '';
            document.querySelector('input[name="purchase_date"]').value = bottle.purchase_date || '';
            document.querySelector('textarea[name="notes"]').value = bottle.notes || '';
            
            // Show photo preview if exists
            const photoPreview = document.getElementById('photo-preview');
            if (bottle.photo_url) {
                photoPreview.innerHTML = `<img src="${bottle.photo_url}" alt="Current photo" style="max-width: 200px; max-height: 200px; border-radius: 4px; margin-top: 0.5rem;"><br><small>Current photo (select new file to replace)</small>`;
            } else {
                photoPreview.innerHTML = '';
            }
            
            // Update button text
            document.getElementById('submit-btn').textContent = 'Update Bottle';
            
            // Show form
            document.getElementById('add-bottle-form').style.display = 'block';
            document.getElementById('add-bottle-form').scrollIntoView({ behavior: 'smooth' });
        })
        .catch(error => {
            console.error('Error loading bottle:', error);
            alert('Error loading bottle details');
        });
}

function deleteBottle(bottleId) {
    if (confirm('Are you sure you want to delete this bottle? This action cannot be undone.')) {
        fetch(`/api/bottles/${bottleId}`, {
            method: 'DELETE'
        })
        .then(response => {
            if (response.ok) {
                loadBottles();
                alert('Bottle deleted successfully');
            } else {
                alert('Error deleting bottle');
            }
        })
        .catch(error => {
            console.error('Error deleting bottle:', error);
            alert('Error deleting bottle');
        });
    }
}

function showImportForm() {
    document.getElementById('import-form').style.display = 'block';
    document.getElementById('add-bottle-form').style.display = 'none';
}

function hideImportForm() {
    document.getElementById('import-form').style.display = 'none';
    document.getElementById('import-form-element').reset();
    document.getElementById('import-results').innerHTML = '';
}

function exportBottles(format) {
    window.location.href = `/api/export/bottles?format=${format}`;
}

function importBottles(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    const preview = document.getElementById('import-preview').checked;
    formData.append('preview', preview);
    
    const resultsDiv = document.getElementById('import-results');
    resultsDiv.innerHTML = '<p>Importing...</p>';
    
    fetch('/api/import/bottles', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            resultsDiv.innerHTML = `<div style="color: #e74c3c; padding: 1rem; background: #fee; border-radius: 4px;">
                <strong>Error:</strong> ${data.error}
                ${data.errors ? '<ul>' + data.errors.map(e => '<li>' + e + '</li>').join('') + '</ul>' : ''}
            </div>`;
        } else if (data.preview) {
            resultsDiv.innerHTML = `<div style="padding: 1rem; background: #e8f4f8; border-radius: 4px;">
                <strong>Preview:</strong> ${data.total} bottles found
                ${data.warnings && data.warnings.length > 0 ? '<p>Warnings: ' + data.warnings.join(', ') + '</p>' : ''}
                <p>First ${Math.min(10, data.bottles.length)} bottles:</p>
                <ul>${data.bottles.map(b => '<li>' + b.name + ' (' + b.category + ')</li>').join('')}</ul>
                <p><em>Uncheck "Preview only" and submit again to import.</em></p>
            </div>`;
        } else {
            resultsDiv.innerHTML = `<div style="color: #27ae60; padding: 1rem; background: #efe; border-radius: 4px;">
                <strong>Success!</strong> Imported ${data.imported} bottles.
                ${data.warnings && data.warnings.length > 0 ? '<p>Warnings: ' + data.warnings.join(', ') + '</p>' : ''}
            </div>`;
            hideImportForm();
            loadBottles();
        }
    })
    .catch(error => {
        console.error('Error importing:', error);
        resultsDiv.innerHTML = `<div style="color: #e74c3c; padding: 1rem; background: #fee; border-radius: 4px;">
            <strong>Error:</strong> Failed to import bottles. Please try again.
        </div>`;
    });
}

// Photo upload functions
function uploadPhoto(bottleId) {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/png,image/jpeg,image/jpg,image/gif';
    input.onchange = function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        const formData = new FormData();
        formData.append('photo', file);
        
        fetch(`/api/bottles/${bottleId}/photo`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error uploading photo: ' + data.error);
            } else {
                loadBottles();
                alert('Photo uploaded successfully!');
            }
        })
        .catch(error => {
            console.error('Error uploading photo:', error);
            alert('Error uploading photo');
        });
    };
    input.click();
}

function deletePhoto(bottleId) {
    if (!confirm('Are you sure you want to delete this photo?')) return;
    
    fetch(`/api/bottles/${bottleId}/photo`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        loadBottles();
        alert('Photo deleted successfully!');
    })
    .catch(error => {
        console.error('Error deleting photo:', error);
        alert('Error deleting photo');
    });
}

// Photo preview on file selection
document.addEventListener('DOMContentLoaded', function() {
    const photoInput = document.getElementById('photo-input');
    if (photoInput) {
        photoInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('photo-preview');
                    preview.innerHTML = `<img src="${e.target.result}" alt="Preview" style="max-width: 200px; max-height: 200px; border-radius: 4px; margin-top: 0.5rem;">`;
                };
                reader.readAsDataURL(file);
            }
        });
    }
});

function lookupBarcode() {
    const barcodeInput = document.getElementById('barcode-input');
    const lookupBtn = document.getElementById('lookup-btn');
    const resultDiv = document.getElementById('barcode-result');

    const barcode = barcodeInput.value.trim();
    if (!barcode) {
        resultDiv.innerHTML = '<span style="color: #dc3545;">Please enter a barcode first.</span>';
        return;
    }

    // Show loading state
    lookupBtn.disabled = true;
    lookupBtn.textContent = 'Looking up...';
    resultDiv.innerHTML = '<span style="color: #007bff;">Searching for product...</span>';

    fetch(`/api/barcode/lookup/${encodeURIComponent(barcode)}`)
        .then(response => response.json())
        .then(data => {
            lookupBtn.disabled = false;
            lookupBtn.textContent = 'Lookup';

            if (data.error) {
                resultDiv.innerHTML = `<span style="color: #dc3545;">${data.error}</span>`;
                return;
            }

            if (data.success && data.product) {
                const product = data.product;

                // Auto-fill form fields
                if (product.name && !document.querySelector('input[name="name"]').value) {
                    document.querySelector('input[name="name"]').value = product.name;
                }

                if (product.category && product.category !== 'other') {
                    document.querySelector('select[name="category"]').value = product.category;
                }

                if (product.abv && !document.querySelector('input[name="abv"]').value) {
                    document.querySelector('input[name="abv"]').value = product.abv;
                }

                // Show success message with product info
                let resultHtml = `<span style="color: #28a745;">✓ Product found!</span><br>`;
                resultHtml += `<strong>${product.name}</strong>`;
                if (product.brand) resultHtml += ` by ${product.brand}`;
                if (product.abv) resultHtml += ` (${product.abv}% ABV)`;
                if (product.category && product.category !== 'other') resultHtml += ` - ${product.category}`;

                resultDiv.innerHTML = resultHtml;
            }
        })
        .catch(error => {
            lookupBtn.disabled = false;
            lookupBtn.textContent = 'Lookup';
            resultDiv.innerHTML = '<span style="color: #dc3545;">Error connecting to barcode service. Please try again.</span>';
            console.error('Barcode lookup error:', error);
        });
}

// Load bottles on page load
loadBottles();
</script>
{% endblock %}

