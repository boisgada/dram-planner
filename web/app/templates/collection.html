{% extends "base.html" %}

{% block title %}Collection - Dram Planner{% endblock %}

{% block content %}
<h1>My Collection</h1>

    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 0.5rem;">
            <h2>Bottles</h2>
            <div style="display: flex; gap: 0.5rem;">
                <button class="btn" onclick="showImportForm()">Import</button>
                <button class="btn" onclick="exportBottles('json')">Export JSON</button>
                <button class="btn" onclick="exportBottles('csv')">Export CSV</button>
                <button class="btn btn-primary" onclick="showAddBottleForm()">Add Bottle</button>
            </div>
        </div>

    <div id="import-form" style="display: none; margin-bottom: 2rem; padding: 1rem; background: #f8f9fa; border-radius: 4px;">
        <h3>Import Bottles</h3>
        <form id="import-form-element" enctype="multipart/form-data" onsubmit="importBottles(event)">
            <div class="form-group">
                <label>File (CSV or JSON)</label>
                <input type="file" name="file" accept=".csv,.json" required>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" name="preview" id="import-preview">
                    Preview only (don't import)
                </label>
            </div>
            <button type="submit" class="btn btn-success">Import</button>
            <button type="button" class="btn" onclick="hideImportForm()">Cancel</button>
        </form>
        <div id="import-results" style="margin-top: 1rem;"></div>
    </div>

    <div id="add-bottle-form" style="display: none; margin-bottom: 2rem; padding: 1rem; background: #f8f9fa; border-radius: 4px;">
        <h3>Add New Bottle</h3>
        <form id="bottle-form" onsubmit="addBottle(event)">
            <div class="form-group">
                <label>Name *</label>
                <input type="text" name="name" required>
            </div>
            <div class="form-group">
                <label>Category *</label>
                <select name="category" required>
                    <option value="bourbon">Bourbon</option>
                    <option value="scotch">Scotch</option>
                    <option value="irish">Irish</option>
                    <option value="gin">Gin</option>
                    <option value="vodka">Vodka</option>
                    <option value="rum">Rum</option>
                    <option value="tequila">Tequila</option>
                    <option value="liqueur">Liqueur</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label>ABV (%)</label>
                <input type="number" name="abv" step="0.1" min="0" max="100">
            </div>
            <div class="form-group">
                <label>Price Paid</label>
                <input type="number" name="price_paid" step="0.01" min="0">
            </div>
            <div class="form-group">
                <label>Purchase Date</label>
                <input type="date" name="purchase_date">
            </div>
            <div class="form-group">
                <label>Notes</label>
                <textarea name="notes" rows="3"></textarea>
            </div>
            <button type="submit" class="btn btn-success">Add Bottle</button>
            <button type="button" class="btn" onclick="hideAddBottleForm()">Cancel</button>
        </form>
    </div>

    <div style="margin-bottom: 1rem;">
        <input type="text" id="search" placeholder="Search bottles..." style="width: 300px; padding: 0.5rem;" onkeyup="loadBottles()">
        <select id="category-filter" onchange="loadBottles()" style="margin-left: 1rem; padding: 0.5rem;">
            <option value="">All Categories</option>
            <option value="bourbon">Bourbon</option>
            <option value="scotch">Scotch</option>
            <option value="irish">Irish</option>
            <option value="gin">Gin</option>
            <option value="vodka">Vodka</option>
            <option value="rum">Rum</option>
            <option value="tequila">Tequila</option>
            <option value="liqueur">Liqueur</option>
            <option value="other">Other</option>
        </select>
        <select id="tasted-filter" onchange="loadBottles()" style="margin-left: 1rem; padding: 0.5rem;">
            <option value="">All</option>
            <option value="true">Tasted</option>
            <option value="false">Untasted</option>
        </select>
    </div>

    <div id="bottles-table">
        <p>Loading bottles...</p>
    </div>
</div>

<script>
function showAddBottleForm() {
    document.getElementById('add-bottle-form').style.display = 'block';
}

function hideAddBottleForm() {
    document.getElementById('add-bottle-form').style.display = 'none';
    document.getElementById('bottle-form').reset();
}

function loadBottles() {
    const search = document.getElementById('search').value;
    const category = document.getElementById('category-filter').value;
    const tasted = document.getElementById('tasted-filter').value;
    
    let url = '/api/bottles?';
    if (search) url += `search=${encodeURIComponent(search)}&`;
    if (category) url += `category=${encodeURIComponent(category)}&`;
    if (tasted) url += `tasted=${tasted}&`;
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            const table = document.getElementById('bottles-table');
            if (data.bottles.length === 0) {
                table.innerHTML = '<p>No bottles found.</p>';
                return;
            }
            
            let html = '<table><thead><tr><th>Name</th><th>Category</th><th>ABV</th><th>Tasted</th><th>Rating</th><th>Actions</th></tr></thead><tbody>';
            data.bottles.forEach(bottle => {
                html += `<tr>
                    <td>${bottle.name}</td>
                    <td>${bottle.category}</td>
                    <td>${bottle.abv || 'N/A'}%</td>
                    <td>${bottle.tasted ? '✓' : '✗'}</td>
                    <td>${bottle.rating || 'N/A'}</td>
                    <td>
                        <button class="btn" onclick="viewBottle(${bottle.id})">View</button>
                        ${!bottle.tasted ? `<button class="btn btn-success" onclick="recordTasting(${bottle.id})">Record Tasting</button>` : ''}
                    </td>
                </tr>`;
            });
            html += '</tbody></table>';
            table.innerHTML = html;
        })
        .catch(error => {
            console.error('Error loading bottles:', error);
            document.getElementById('bottles-table').innerHTML = '<p>Error loading bottles.</p>';
        });
}

function addBottle(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    const data = Object.fromEntries(formData);
    
    fetch('/api/bottles', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        hideAddBottleForm();
        loadBottles();
        alert('Bottle added successfully!');
    })
    .catch(error => {
        console.error('Error adding bottle:', error);
        alert('Error adding bottle');
    });
}

function recordTasting(bottleId) {
    const rating = prompt('Enter rating (0-10):');
    const notes = prompt('Enter tasting notes:');
    const date = prompt('Enter tasting date (YYYY-MM-DD) or leave blank for today:') || new Date().toISOString().split('T')[0];
    
    if (rating) {
        fetch(`/api/bottles/${bottleId}/tasting`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                rating: parseFloat(rating),
                tasting_notes: notes || '',
                tasting_date: date
            })
        })
        .then(response => response.json())
        .then(data => {
            loadBottles();
            alert('Tasting recorded!');
        })
        .catch(error => {
            console.error('Error recording tasting:', error);
            alert('Error recording tasting');
        });
    }
}

function viewBottle(bottleId) {
    // Simple view - could be enhanced with modal
    fetch(`/api/bottles/${bottleId}`)
        .then(response => response.json())
        .then(bottle => {
            alert(`Bottle: ${bottle.name}\nCategory: ${bottle.category}\nABV: ${bottle.abv}%\nNotes: ${bottle.notes || 'None'}`);
        });
}

function showImportForm() {
    document.getElementById('import-form').style.display = 'block';
    document.getElementById('add-bottle-form').style.display = 'none';
}

function hideImportForm() {
    document.getElementById('import-form').style.display = 'none';
    document.getElementById('import-form-element').reset();
    document.getElementById('import-results').innerHTML = '';
}

function exportBottles(format) {
    window.location.href = `/api/export/bottles?format=${format}`;
}

function importBottles(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    const preview = document.getElementById('import-preview').checked;
    formData.append('preview', preview);
    
    const resultsDiv = document.getElementById('import-results');
    resultsDiv.innerHTML = '<p>Importing...</p>';
    
    fetch('/api/import/bottles', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            resultsDiv.innerHTML = `<div style="color: #e74c3c; padding: 1rem; background: #fee; border-radius: 4px;">
                <strong>Error:</strong> ${data.error}
                ${data.errors ? '<ul>' + data.errors.map(e => '<li>' + e + '</li>').join('') + '</ul>' : ''}
            </div>`;
        } else if (data.preview) {
            resultsDiv.innerHTML = `<div style="padding: 1rem; background: #e8f4f8; border-radius: 4px;">
                <strong>Preview:</strong> ${data.total} bottles found
                ${data.warnings && data.warnings.length > 0 ? '<p>Warnings: ' + data.warnings.join(', ') + '</p>' : ''}
                <p>First ${Math.min(10, data.bottles.length)} bottles:</p>
                <ul>${data.bottles.map(b => '<li>' + b.name + ' (' + b.category + ')</li>').join('')}</ul>
                <p><em>Uncheck "Preview only" and submit again to import.</em></p>
            </div>`;
        } else {
            resultsDiv.innerHTML = `<div style="color: #27ae60; padding: 1rem; background: #efe; border-radius: 4px;">
                <strong>Success!</strong> Imported ${data.imported} bottles.
                ${data.warnings && data.warnings.length > 0 ? '<p>Warnings: ' + data.warnings.join(', ') + '</p>' : ''}
            </div>`;
            hideImportForm();
            loadBottles();
        }
    })
    .catch(error => {
        console.error('Error importing:', error);
        resultsDiv.innerHTML = `<div style="color: #e74c3c; padding: 1rem; background: #fee; border-radius: 4px;">
            <strong>Error:</strong> Failed to import bottles. Please try again.
        </div>`;
    });
}

// Load bottles on page load
loadBottles();
</script>
{% endblock %}

