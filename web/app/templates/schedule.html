{% extends "base.html" %}

{% block title %}Schedule - Dram Planner{% endblock %}

{% block content %}
<h1>Tasting Schedule</h1>

<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h2>Schedules</h2>
        <button class="btn btn-primary" onclick="showGenerateForm()">Generate New Schedule</button>
    </div>

    <div id="generate-form" style="display: none; margin-bottom: 2rem; padding: 1rem; background: #f8f9fa; border-radius: 4px;">
        <h3>Generate Schedule</h3>
        <form id="schedule-form" onsubmit="generateSchedule(event)">
            <div class="form-group">
                <label>Schedule Name</label>
                <input type="text" name="name" placeholder="My Tasting Schedule">
            </div>
            <div class="form-group">
                <label>Start Date</label>
                <input type="date" name="start_date" id="start_date">
            </div>
            <div class="form-group">
                <label>Duration (weeks)</label>
                <input type="number" name="weeks" value="104" min="1">
            </div>
            <button type="submit" class="btn btn-success">Generate</button>
            <button type="button" class="btn" onclick="hideGenerateForm()">Cancel</button>
        </form>
    </div>

    <div id="schedules-list">
        <p>Loading schedules...</p>
    </div>
</div>

<div class="card" id="schedule-details" style="display: none;">
    <h2 id="schedule-name"></h2>
    <div id="schedule-items"></div>
</div>

<script>
const today = new Date().toISOString().split('T')[0];

function showGenerateForm() {
    document.getElementById('generate-form').style.display = 'block';
    document.getElementById('start_date').value = today;
}

function hideGenerateForm() {
    document.getElementById('generate-form').style.display = 'none';
    document.getElementById('schedule-form').reset();
}

function loadSchedules() {
    fetch('/api/schedules')
        .then(response => response.json())
        .then(data => {
            const list = document.getElementById('schedules-list');
            if (data.schedules.length === 0) {
                list.innerHTML = '<p>No schedules yet. Generate one to get started!</p>';
                return;
            }
            
            let html = '<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Start Date</th><th>Weeks</th><th>Generated</th><th>Actions</th></tr></thead><tbody>';
            data.schedules.forEach(schedule => {
                html += `<tr>
                    <td>${schedule.name}</td>
                    <td>${schedule.start_date}</td>
                    <td>${schedule.weeks}</td>
                    <td>${new Date(schedule.generated_at).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-primary" onclick="viewSchedule(${schedule.id})">View</button>
                        <button class="btn btn-danger" onclick="deleteSchedule(${schedule.id})">Delete</button>
                    </td>
                </tr>`;
            });
            html += '</tbody></table></div>';
            list.innerHTML = html;
        })
        .catch(error => {
            console.error('Error loading schedules:', error);
            document.getElementById('schedules-list').innerHTML = '<p>Error loading schedules.</p>';
        });
}

function generateSchedule(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    const data = Object.fromEntries(formData);
    data.weeks = parseInt(data.weeks);
    
    fetch('/api/schedules', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        hideGenerateForm();
        loadSchedules();
        viewSchedule(data.id);
        alert('Schedule generated successfully!');
    })
    .catch(error => {
        console.error('Error generating schedule:', error);
        alert('Error generating schedule. Make sure you have bottles in your collection.');
    });
}

function viewSchedule(scheduleId) {
    fetch(`/api/schedules/${scheduleId}`)
        .then(response => response.json())
        .then(schedule => {
            document.getElementById('schedule-name').textContent = schedule.name;
            const itemsDiv = document.getElementById('schedule-items');
            
            let html = '<div class="table-wrapper"><table><thead><tr><th>Week</th><th>Date</th><th>Bottle</th><th>Category</th><th>ABV</th><th>Status</th><th>Actions</th></tr></thead><tbody>';
            schedule.items.forEach(item => {
                const bottle = item.bottle;
                html += `<tr>
                    <td>${item.week}</td>
                    <td>${item.date}</td>
                    <td>${bottle ? bottle.name : 'N/A'}</td>
                    <td>${bottle ? bottle.category : 'N/A'}</td>
                    <td>${bottle ? (bottle.abv || 'N/A') + '%' : 'N/A'}</td>
                    <td>${item.completed ? 'âœ“ Completed' : 'Pending'}</td>
                    <td>
                        ${!item.completed ? `<button class="btn btn-success" onclick="completeItem(${scheduleId}, ${item.id})">Complete</button>` : ''}
                    </td>
                </tr>`;
            });
            html += '</tbody></table></div>';
            itemsDiv.innerHTML = html;
            document.getElementById('schedule-details').style.display = 'block';
        })
        .catch(error => {
            console.error('Error loading schedule:', error);
            alert('Error loading schedule');
        });
}

function completeItem(scheduleId, itemId) {
    fetch(`/api/schedules/${scheduleId}/items/${itemId}/complete`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        viewSchedule(scheduleId);
    })
    .catch(error => {
        console.error('Error completing item:', error);
        alert('Error completing item');
    });
}

function deleteSchedule(scheduleId) {
    if (confirm('Are you sure you want to delete this schedule?')) {
        fetch(`/api/schedules/${scheduleId}`, {
            method: 'DELETE'
        })
        .then(() => {
            loadSchedules();
            document.getElementById('schedule-details').style.display = 'none';
        })
        .catch(error => {
            console.error('Error deleting schedule:', error);
            alert('Error deleting schedule');
        });
    }
}

// Load schedules on page load
loadSchedules();
</script>
{% endblock %}

