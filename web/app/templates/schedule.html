{% extends "base.html" %}

{% block title %}Schedule - Dram Planner{% endblock %}

{% block content %}
<style>
.calendar-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
}

.calendar-table th, .calendar-table td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: center;
    vertical-align: top;
    height: 100px;
    min-width: 120px;
}

.calendar-table th {
    background-color: #f8f9fa;
    font-weight: bold;
}

.calendar-cell {
    cursor: pointer;
    transition: background-color 0.2s;
}

.calendar-cell:hover {
    background-color: #f8f9fa;
}

.calendar-cell.today {
    background-color: #e3f2fd;
    font-weight: bold;
}

.calendar-cell.other-month {
    background-color: #f5f5f5;
    color: #999;
}

.calendar-cell.has-tasting {
    background-color: #fff3cd;
}

.calendar-date {
    font-size: 14px;
    font-weight: bold;
    margin-bottom: 4px;
}

.calendar-tastings {
    font-size: 11px;
    color: #666;
}

.calendar-tasting {
    background-color: #007bff;
    color: white;
    padding: 2px 4px;
    border-radius: 3px;
    margin: 2px 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
</style>
<h1>Tasting Schedule</h1>

<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h2>Schedules</h2>
        <button class="btn btn-primary" onclick="showGenerateForm()">Generate New Schedule</button>
    </div>

    <div id="generate-form" style="display: none; margin-bottom: 2rem; padding: 1rem; background: #f8f9fa; border-radius: 4px;">
        <h3>Generate Schedule</h3>
        <form id="schedule-form" onsubmit="generateSchedule(event)">
            <div class="form-group">
                <label>Schedule Name</label>
                <input type="text" name="name" placeholder="My Tasting Schedule">
            </div>
            <div class="form-group">
                <label>Start Date</label>
                <input type="date" name="start_date" id="start_date">
            </div>
            <div class="form-group">
                <label>Duration (weeks)</label>
                <input type="number" name="weeks" value="104" min="1">
            </div>
            <button type="submit" class="btn btn-success">Generate</button>
            <button type="button" class="btn" onclick="hideGenerateForm()">Cancel</button>
        </form>
    </div>

    <div id="schedules-list">
        <p>Loading schedules...</p>
    </div>
</div>

<div class="card" id="schedule-details" style="display: none;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h2 id="schedule-name"></h2>
        <div>
            <button class="btn" id="list-view-btn" onclick="showListView()">List View</button>
            <button class="btn btn-primary" id="calendar-view-btn" onclick="showCalendarView()">Calendar View</button>
            <button class="btn" id="export-schedule-btn" onclick="exportCurrentSchedule()" style="display: none;">Export iCal</button>
        </div>
    </div>

    <!-- List View -->
    <div id="schedule-list-view">
        <div id="schedule-items"></div>
    </div>

    <!-- Calendar View -->
    <div id="schedule-calendar-view" style="display: none;">
        <div class="calendar-controls" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <button class="btn" onclick="previousMonth()">&larr; Previous</button>
            <h3 id="calendar-month-year"></h3>
            <button class="btn" onclick="nextMonth()">Next &rarr;</button>
            <button class="btn" onclick="goToToday()">Today</button>
        </div>
        <div id="calendar-grid"></div>
    </div>
</div>

<script>
const today = new Date().toISOString().split('T')[0];

function showGenerateForm() {
    document.getElementById('generate-form').style.display = 'block';
    document.getElementById('start_date').value = today;
}

function hideGenerateForm() {
    document.getElementById('generate-form').style.display = 'none';
    document.getElementById('schedule-form').reset();
}

function loadSchedules() {
    fetch('/api/schedules')
        .then(response => response.json())
        .then(data => {
            const list = document.getElementById('schedules-list');
            if (data.schedules.length === 0) {
                list.innerHTML = '<p>No schedules yet. Generate one to get started!</p>';
                return;
            }
            
            let html = '<table><thead><tr><th>Name</th><th>Start Date</th><th>Weeks</th><th>Generated</th><th>Actions</th></tr></thead><tbody>';
            data.schedules.forEach(schedule => {
                html += `<tr>
                    <td>${schedule.name}</td>
                    <td>${schedule.start_date}</td>
                    <td>${schedule.weeks}</td>
                    <td>${new Date(schedule.generated_at).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-primary" onclick="viewSchedule(${schedule.id})">View</button>
                        <button class="btn" onclick="exportSchedule(${schedule.id})">Export iCal</button>
                        <button class="btn btn-danger" onclick="deleteSchedule(${schedule.id})">Delete</button>
                    </td>
                </tr>`;
            });
            html += '</tbody></table>';
            list.innerHTML = html;
        })
        .catch(error => {
            console.error('Error loading schedules:', error);
            document.getElementById('schedules-list').innerHTML = '<p>Error loading schedules.</p>';
        });
}

function generateSchedule(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    const data = Object.fromEntries(formData);
    data.weeks = parseInt(data.weeks);
    
    fetch('/api/schedules', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        hideGenerateForm();
        loadSchedules();
        viewSchedule(data.id);
        alert('Schedule generated successfully!');
    })
    .catch(error => {
        console.error('Error generating schedule:', error);
        alert('Error generating schedule. Make sure you have bottles in your collection.');
    });
}

let currentScheduleId = null;

function viewSchedule(scheduleId) {
    currentScheduleId = scheduleId;
    fetch(`/api/schedules/${scheduleId}`)
        .then(response => response.json())
        .then(schedule => {
            document.getElementById('schedule-name').textContent = schedule.name;
            document.getElementById('export-schedule-btn').style.display = 'block';

            // Store schedule items for calendar view
            currentScheduleItems = schedule.items.map(item => ({
                ...item,
                tasting_date: item.date,
                bottle_name: item.bottle ? item.bottle.name : 'N/A',
                category: item.bottle ? item.bottle.category : 'N/A',
                notes: item.notes || ''
            }));

            // Set default view to list
            showListView();

            const itemsDiv = document.getElementById('schedule-items');

            let html = '<table><thead><tr><th>Week</th><th>Date</th><th>Bottle</th><th>Category</th><th>ABV</th><th>Status</th><th>Actions</th></tr></thead><tbody>';
            schedule.items.forEach(item => {
                const bottle = item.bottle;
                html += `<tr>
                    <td>${item.week}</td>
                    <td>${item.date}</td>
                    <td>${bottle ? bottle.name : 'N/A'}</td>
                    <td>${bottle ? bottle.category : 'N/A'}</td>
                    <td>${bottle ? (bottle.abv || 'N/A') + '%' : 'N/A'}</td>
                    <td>${item.completed ? '✓ Completed' : 'Pending'}</td>
                    <td>
                        ${!item.completed ? `<button class="btn btn-success" onclick="completeItem(${scheduleId}, ${item.id})">Complete</button>` : ''}
                    </td>
                </tr>`;
            });
            html += '</tbody></table>';
            itemsDiv.innerHTML = html;
            document.getElementById('schedule-details').style.display = 'block';
        })
        .catch(error => {
            console.error('Error loading schedule:', error);
            alert('Error loading schedule');
        });
}

function completeItem(scheduleId, itemId) {
    fetch(`/api/schedules/${scheduleId}/items/${itemId}/complete`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        viewSchedule(scheduleId);
    })
    .catch(error => {
        console.error('Error completing item:', error);
        alert('Error completing item');
    });
}

function deleteSchedule(scheduleId) {
    if (confirm('Are you sure you want to delete this schedule?')) {
        fetch(`/api/schedules/${scheduleId}`, {
            method: 'DELETE'
        })
        .then(() => {
            loadSchedules();
            document.getElementById('schedule-details').style.display = 'none';
        })
        .catch(error => {
            console.error('Error deleting schedule:', error);
            alert('Error deleting schedule');
        });
    }
}

function exportSchedule(scheduleId) {
    window.location.href = `/api/export/schedule/${scheduleId}`;
}

function exportCurrentSchedule() {
    if (currentScheduleId) {
        exportSchedule(currentScheduleId);
    }
}

// Calendar state
let currentCalendarDate = new Date();
let currentScheduleItems = [];

// Calendar functions
function showCalendarView() {
    document.getElementById('schedule-list-view').style.display = 'none';
    document.getElementById('schedule-calendar-view').style.display = 'block';
    document.getElementById('list-view-btn').classList.remove('btn-primary');
    document.getElementById('calendar-view-btn').classList.add('btn-primary');
    renderCalendar();
}

function showListView() {
    document.getElementById('schedule-calendar-view').style.display = 'none';
    document.getElementById('schedule-list-view').style.display = 'block';
    document.getElementById('calendar-view-btn').classList.remove('btn-primary');
    document.getElementById('list-view-btn').classList.add('btn-primary');
}

function previousMonth() {
    currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
    renderCalendar();
}

function nextMonth() {
    currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
    renderCalendar();
}

function goToToday() {
    currentCalendarDate = new Date();
    renderCalendar();
}

function renderCalendar() {
    const month = currentCalendarDate.getMonth();
    const year = currentCalendarDate.getFullYear();

    // Update month/year display
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                       'July', 'August', 'September', 'October', 'November', 'December'];
    document.getElementById('calendar-month-year').textContent = `${monthNames[month]} ${year}`;

    // Get first day of month and last day
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startDate = new Date(firstDay);
    startDate.setDate(startDate.getDate() - firstDay.getDay()); // Start from Sunday

    // Create calendar grid
    let html = '<table class="calendar-table"><thead><tr>';
    const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    dayNames.forEach(day => {
        html += `<th>${day}</th>`;
    });
    html += '</tr></thead><tbody>';

    let currentDate = new Date(startDate);

    for (let week = 0; week < 6; week++) {
        html += '<tr>';
        for (let day = 0; day < 7; day++) {
            const dateStr = currentDate.toISOString().split('T')[0];
            const isCurrentMonth = currentDate.getMonth() === month;
            const isToday = dateStr === new Date().toISOString().split('T')[0];
            const tastings = getTastingsForDate(dateStr);

            let cellClass = 'calendar-cell';
            if (!isCurrentMonth) cellClass += ' other-month';
            if (isToday) cellClass += ' today';
            if (tastings.length > 0) cellClass += ' has-tasting';

            html += `<td class="${cellClass}" onclick="showDateDetails('${dateStr}')">`;
            html += `<div class="calendar-date">${currentDate.getDate()}</div>`;

            if (tastings.length > 0) {
                html += '<div class="calendar-tastings">';
                tastings.forEach(tasting => {
                    html += `<div class="calendar-tasting">${tasting.bottle_name}</div>`;
                });
                html += '</div>';
            }

            html += '</td>';
            currentDate.setDate(currentDate.getDate() + 1);
        }
        html += '</tr>';

        // Stop if we've gone past the end of the month
        if (currentDate.getMonth() > month && week >= 3) break;
    }

    html += '</tbody></table>';
    document.getElementById('calendar-grid').innerHTML = html;
}

function getTastingsForDate(dateStr) {
    return currentScheduleItems.filter(item => item.tasting_date === dateStr);
}

function showDateDetails(dateStr) {
    const tastings = getTastingsForDate(dateStr);
    if (tastings.length === 0) {
        alert(`No tastings scheduled for ${dateStr}`);
        return;
    }

    let message = `Tastings for ${dateStr}:\n\n`;
    tastings.forEach(tasting => {
        message += `• ${tasting.bottle_name} (${tasting.category})\n`;
        if (tasting.notes) message += `  Notes: ${tasting.notes}\n`;
    });

    alert(message);
}

// Load schedules on page load
loadSchedules();
</script>
{% endblock %}

